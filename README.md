# SheNeeds - Donation Platform Backend

Flask REST API for the SheNeeds Donation Platform - connecting donors with verified charities focused on menstrual health education and access.

## üìñ About

SheNeeds is a donation platform designed to bridge the gap between generous donors and verified charitable organizations working to improve menstrual health education and access. The backend provides a robust REST API with role-based access control, secure authentication, and comprehensive donation management.

### Key Features

-  **JWT Authentication** - Secure user authentication with role-based access control
-  **Multi-Role System** - Support for donors, charities, and administrators
-  **Charity Verification** - Application and approval process for charities
-  **Donation Management** - Track and manage donations with detailed records
- üìä **Dashboard Analytics** - Real-time statistics for charities and administrators
- üõ°Ô∏è **Error Handling** - Comprehensive error handling with standardized responses
- üóÑÔ∏è **Database Migrations** - Flask-Migrate for version-controlled database schema
- üìù **API Documentation** - Well-documented REST endpoints

## Tech Stack

- **Flask 3.0** - Web framework
- **Flask-SQLAlchemy** - ORM
- **Flask-JWT-Extended** - JWT authentication
- **Flask-CORS** - Cross-origin support
- **Flask-Migrate** - Database migrations
- **SQLite/PostgreSQL** - Database

## Architecture

```
app/
‚îú‚îÄ‚îÄ __init__.py          # Flask application factory
‚îú‚îÄ‚îÄ config.py            # Configuration classes (Dev/Test/Prod)
‚îú‚îÄ‚îÄ extensions.py        # Flask extensions (db, jwt, cors, migrate)
‚îú‚îÄ‚îÄ models/              # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user.py          # User model with auth methods
‚îÇ   ‚îú‚îÄ‚îÄ charity.py       # Charity + CharityApplication models
‚îÇ   ‚îî‚îÄ‚îÄ donation.py      # Donation model
‚îú‚îÄ‚îÄ routes/              # API route blueprints
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ health.py        # Health check endpoint
‚îÇ   ‚îú‚îÄ‚îÄ auth.py          # Authentication routes
‚îÇ   ‚îú‚îÄ‚îÄ donor.py         # Donor routes
‚îÇ   ‚îú‚îÄ‚îÄ charity.py       # Charity routes
‚îÇ   ‚îî‚îÄ‚îÄ admin.py         # Admin routes
‚îú‚îÄ‚îÄ services/            # Business logic layer
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user_service.py
‚îÇ   ‚îú‚îÄ‚îÄ charity_service.py
‚îÇ   ‚îî‚îÄ‚îÄ donation_service.py
‚îú‚îÄ‚îÄ auth/                # Authentication & authorization
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ decorators.py    # Role-based access decorators
‚îÇ   ‚îî‚îÄ‚îÄ handlers.py      # JWT error handlers
‚îú‚îÄ‚îÄ errors/              # Error handling
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ responses.py     # Standardized error responses
‚îÇ   ‚îî‚îÄ‚îÄ handlers.py      # Global error handlers
‚îî‚îÄ‚îÄ utils/               # Utility functions
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ helpers.py
```

## Quick Start

### Local Development

```bash
cd Donation-Platform-backend

# Create virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# Install dependencies
pip install -r requirements.txt

# Copy local development environment file
cp .env.local .env

# Run database migrations
flask db upgrade

# Create admin user
python seed_admin.py

# Seed with test data (development only - destructive!)
python seed_db.py

# Run the server
python run_app.py
```

Server runs at `http://localhost:5000`

### Environment Configuration

| Variable | Local Development | Production (Render) |
|----------|-------------------|---------------------|
| `FLASK_ENV` | `development` | `production` |
| `FLASK_DEBUG` | `1` | `0` |
| `DATABASE_URL` | (omit for SQLite) | Render provides this |
| `CORS_ORIGINS` | `*` | `https://your-frontend.onrender.com` |
| `SECRET_KEY` | dev-key (any) | Auto-generated by Render |
| `JWT_SECRET_KEY` | dev-key (any) | Auto-generated by Render |

### Production Deployment (Render)

The `render.yaml` blueprint handles deployment automatically. For existing databases:

```bash
# If tables already exist but Alembic is not synced:
flask db stamp head  # Mark current DB state as migrated
flask db upgrade     # Apply any new migrations (no-op if up to date)
```

> **Note:** Use Flask-Migrate for all database schema changes. Never use `db.create_all()` in production.

## Recent Improvements (Feb 2026)

### üîß Audit Fixes Applied

**Data Integrity:**
- ‚úÖ Added DB CHECK constraints: `donation.amount > 0`, `user.role IN (donor, charity, admin)`
- ‚úÖ Fixed nullable defaults in migrations (boolean fields now `NOT NULL` with `server_default`)
- ‚úÖ Charity donations now properly include donor_id for non-anonymous donations

**API Consistency:**
- ‚úÖ Renamed `total_donated_dollars` ‚Üí `total_donated_kes` (KES-only platform)
- ‚úÖ Added `total_donations_kes` to charity stats responses
- ‚úÖ Standardized charity list responses (all include pagination wrapper)
- ‚úÖ Added frontend compatibility aliases: `region`, `image`, `verified` fields

**Code Cleanup:**
- ‚úÖ Removed duplicate `/donor/donate/mpesa` endpoint (use `/api/donations/mpesa`)
- ‚úÖ All list endpoints now paginated (`page`, `per_page`, `total`, `pages`)

**Migrations:**
- `3a2b9c4d5e6f` - Fix nullable defaults (boolean fields)
- `4b3c0d1e2f3g` - Add CHECK constraints (amount, role)

### ‚ö†Ô∏è Security Note
M-Pesa callback endpoint requires signature validation before production deployment.

## Configuration

Environment variables (set in `.env`):

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_KEY` | Flask secret key | dev-secret-key |
| `JWT_SECRET_KEY` | JWT signing key | jwt-secret-key |
| `JWT_EXPIRES_HOURS` | Token expiration | 24 |
| `FLASK_ENV` | Environment | development |
| `DATABASE_URL` | Full database URL | SQLite |
| `POSTGRES_HOST` | PostgreSQL host | - |
| `POSTGRES_USER` | PostgreSQL user | - |
| `POSTGRES_PASSWORD` | PostgreSQL password | - |
| `POSTGRES_DB` | PostgreSQL database | - |

## API Endpoints

### Health Check
- `GET /health` - Service health check

### Authentication (`/auth`)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/register` | Register new user | No |
| POST | `/login` | Login, get JWT | No |
| GET | `/me` | Get current user | Yes |

### Donor Routes (`/donor`)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/charities` | List active charities (paginated) | Donor |
| GET | `/charities/:id` | Get charity details | Donor |
| GET | `/donations` | Get donation history (paginated) | Donor |
| GET | `/dashboard` | Get donor stats | Donor |

### Donation API (`/api/donations`)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/mpesa` | Initiate M-Pesa STK Push | Donor |
| GET | `/:id/status` | Poll donation status | Donor |

### Charity Routes (`/charity`)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/apply` | Submit application | Charity |
| GET | `/application` | Get application status | Charity |
| GET | `/profile` | Get charity profile | Charity |
| PUT | `/profile` | Update profile | Charity |
| GET | `/donations` | Get received donations | Charity |
| GET | `/dashboard` | Get dashboard stats | Charity |

### Admin Routes (`/admin`)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/users` | List all users (paginated) | Admin |
| GET | `/applications` | List applications (paginated) | Admin |
| GET | `/applications/:id` | Get application | Admin |
| POST | `/applications/:id/approve` | Approve application | Admin |
| POST | `/applications/:id/reject` | Reject application | Admin |
| GET | `/charities` | List all charities (paginated) | Admin |
| GET | `/charities/:id` | Get charity details | Admin |
| DELETE | `/charities/:id` | Deactivate charity | Admin |
| POST | `/charities/:id/activate` | Reactivate charity | Admin |
| GET | `/stats` | Platform statistics | Admin |

### Public Routes
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/charities` | List active charities (paginated) | No |
| GET | `/charities/:id` | Get charity details | No |

## Authentication

All protected routes require a JWT token in the Authorization header:

```
Authorization: Bearer <access_token>
```

Tokens are obtained via `/auth/login` or `/auth/register`.

### Roles
- **donor** - Can browse charities and make donations
- **charity** - Can manage charity profile and view donations
- **admin** - Full platform management access

## Test Credentials

After seeding with `python seed_db.py`:

| Role | Email | Password |
|------|-------|----------|
| Admin | `admin@test.com` | `admin123` |
| Donor | `donor@test.com` | `donor123` |
| Charity | `charity@test.com` | `charity123` |

## Dependencies

- Flask 3.0.0
- Flask-SQLAlchemy (ORM)
- Flask-JWT-Extended (Auth)
- Flask-CORS (Cross-origin)
- Flask-Migrate (Migrations)
- python-dotenv (Env vars)
- Werkzeug (Password hashing)

## Development

### Running with Frontend

1. Start the backend:
   ```bash
   cd Donation-Platform-backend
   python run_app.py
   ```

2. Start the frontend (in another terminal):
   ```bash
   cd Donation-Platform-frontend
   npm run dev
   ```

3. Access the app at `http://localhost:5173`

### Adding New Routes

1. Create route file in `app/routes/`
2. Register blueprint in `app/routes/__init__.py`
3. Add service methods in `app/services/` if needed

### Database Migrations

```bash
# Apply pending migrations (always run after git pull)
flask db upgrade

# Create new migration after model changes
flask db migrate -m "Description of changes"

# Downgrade one migration (if needed)
flask db downgrade

# View migration history
flask db history
```

**Important Migration Notes:**
- Always review auto-generated migrations before applying
- Use `server_default` for boolean/default fields to ensure NOT NULL constraints
- Test migrations on development database before production
- Never edit applied migrations - create new ones instead

## Troubleshooting

### Common Issues

**Database schema out of sync**
```bash
# Apply all pending migrations
flask db upgrade

# If migrations are broken, reset database (DEVELOPMENT ONLY - DESTRUCTIVE!)
rm instance/app.db
flask db upgrade

# For production, always create proper migration instead
flask db migrate -m "Fix schema issue"
flask db upgrade
```

**JWT token errors**
- Ensure `JWT_SECRET_KEY` is set in your environment
- Check token expiration time
- Verify token is included in Authorization header

**CORS issues**
- Check that `FLASK_CORS_ORIGINS` includes your frontend URL
- Default allows `http://localhost:5173`

**Import errors**
- Ensure virtual environment is activated
- Reinstall dependencies: `pip install -r requirements.txt`

## Deployment

### Production Checklist

- [ ] Set strong `SECRET_KEY` and `JWT_SECRET_KEY`
- [ ] Use PostgreSQL instead of SQLite
- [ ] Set `FLASK_ENV=production`
- [ ] Configure proper CORS origins
- [ ] Enable HTTPS
- [ ] Set up proper logging
- [ ] Use a production WSGI server (gunicorn, uWSGI)

### Example Production Deployment

```bash
# Install production server
pip install gunicorn

# Run with gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 run_app:app
```

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

MIT

---

Built with ‚ù§Ô∏è for menstrual health advocacy
