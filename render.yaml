# render.yaml — Render Blueprint (Infrastructure as Code)
#
# Deploy: https://render.com/deploy → connect your repo → Render reads this file
# After deploy, fill in the sync: false environment variable values in the Render dashboard.
#
# Documentation: https://render.com/docs/blueprint-spec
# Updated: February 10, 2026

databases:
  - name: donation-platform-db
    plan: free  # Options: free, starter, standard, pro (upgrade for production)
    databaseName: donation_platform
    user: donation_user
    # PostgreSQL version is automatically set to latest stable (15+)

services:
  - type: web
    name: donation-platform-api
    runtime: python
    plan: free  # Options: free (sleeps after 15min), starter (always-on), standard, pro
    branch: ayman/dev  # Auto-deploy from this branch
    
    # Build & Start Commands
    buildCommand: pip install -r requirements.txt && flask db upgrade && python seed_admin.py
    startCommand: gunicorn -w 4 -b 0.0.0.0:$PORT run_app:app --timeout 120 --log-level info
    
    # Health Check (Render pings this to verify service is running)
    healthCheckPath: /health
    
    # Environment Variables
    envVars:
      # ==================== Flask Configuration ====================
      - key: FLASK_ENV
        value: production
      
      - key: FLASK_DEBUG
        value: "false"
      
      - key: SECRET_KEY
        generateValue: true  # Render auto-generates secure random key
      
      # ==================== Database ====================
      - key: DATABASE_URL
        fromDatabase:
          name: donation-platform-db
          property: connectionString  # Uses Internal Database URL (faster)
      
      # ==================== JWT Authentication ====================
      - key: JWT_SECRET_KEY
        generateValue: true  # Render auto-generates secure random key
      
      - key: JWT_ACCESS_TOKEN_EXPIRES
        value: "86400"  # 24 hours in seconds
      
      # ==================== CORS Configuration ====================
      # CRITICAL: Set this to your EXACT frontend URL (no trailing slash)
      # Example: https://donation-platform-frontend.onrender.com
      - key: CORS_ORIGINS
        sync: false  # MUST set in Render dashboard after frontend is deployed
      
      # ==================== Admin User Setup ====================
      # Set these to customize the initial admin user
      - key: ADMIN_EMAIL
        value: admin@sheneeds.org  # Default admin email
      
      - key: ADMIN_PASSWORD
        sync: false  # MUST set in Render dashboard (or leave blank for auto-generated)
      
      # ==================== M-Pesa Daraja API (Sandbox) ====================
      # Get credentials from: https://developer.safaricom.co.ke
      - key: MPESA_ENV
        value: sandbox  # Change to 'production' after Safaricom approval
      
      - key: MPESA_CONSUMER_KEY
        sync: false  # Set in Render dashboard from Safaricom Developer Portal
      
      - key: MPESA_CONSUMER_SECRET
        sync: false  # Set in Render dashboard from Safaricom Developer Portal
      
      - key: MPESA_SHORTCODE
        value: "174379"  # Sandbox shortcode (change for production)
      
      - key: MPESA_PASSKEY
        sync: false  # Set in Render dashboard from Safaricom Developer Portal
      
      # CRITICAL: Must be HTTPS in production
      # Replace <your-backend> with actual Render service name
      - key: MPESA_STK_CALLBACK_URL
        sync: false  # Set to: https://<your-backend>.onrender.com/api/mpesa/callback
      
      - key: MPESA_TIMEOUT_URL
        sync: false  # Set to: https://<your-backend>.onrender.com/api/mpesa/timeout
      
      # ==================== Email Configuration (Optional) ====================
      # Uncomment and configure if you want to send donation receipts via email
      # - key: MAIL_SERVER
      #   value: smtp.gmail.com
      # 
      # - key: MAIL_PORT
      #   value: "587"
      # 
      # - key: MAIL_USE_TLS
      #   value: True
      # 
      # - key: MAIL_USERNAME
      #   sync: false
      # 
      # - key: MAIL_PASSWORD
      #   sync: false  # Use Gmail App Password, not regular password
      
      # ==================== File Upload Configuration ====================
      - key: UPLOAD_FOLDER
        value: /tmp/uploads  # Ephemeral storage (files deleted on restart)
      
      - key: MAX_CONTENT_LENGTH
        value: "16777216"  # 16MB max upload size
